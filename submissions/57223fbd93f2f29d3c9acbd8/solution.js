class BloomFilter {
  constructor(buffer, hashes) {
    this.buffer = buffer;
    this.hashes = hashes;
  }

  _getBit(index) {
    const byteIndex = index >>> 3;
    const bitIndex = index - (byteIndex << 3);
    return (this.buffer[byteIndex] >>> bitIndex) & 1;
  }

  _setBit(index) {
    const byteIndex = index >>> 3;
    const bitIndex = index - (byteIndex << 3);
    this.buffer[byteIndex] |= 1 << bitIndex;
  }

  add(word) {
    this.hashes.map(hash => hash(word) % (this.buffer.length << 3))
      .forEach(this._setBit, this);
  }

  test(word) {
    return this.hashes.map(hash => hash(word) % (this.buffer.length << 3))
      .every(this._getBit, this);
  }

  getBuffer() {
    return this.buffer;
  }
}

module.exports = BloomFilter;
const freq = {"a":{"a":0.0018,"b":0.0395,"c":0.0597,"d":0.0341,"e":0.027,"f":0.0079,"g":0.0289,"h":0.0083,"i":0.0251,"j":0.0016,"k":0.0121,"l":0.1233,"m":0.0429,"n":0.1535,"o":0.0018,"p":0.0339,"q":0.0015,"r":0.1146,"s":0.0621,"t":0.1273,"u":0.0215,"v":0.0128,"w":0.0076,"x":0.0045,"y":0.0117,"z":0.006,"'":0.0304},"b":{"a":0.1515,"b":0.0272,"c":0.0055,"d":0.0062,"e":0.1481,"f":0.002,"g":0.0012,"h":0.0035,"i":0.1402,"j":0.0036,"k":0.0008,"l":0.1495,"m":0.0038,"n":0.0028,"o":0.1179,"p":0.0026,"q":0.0002,"r":0.1013,"s":0.0231,"t":0.0062,"u":0.0834,"v":0.0019,"w":0.0017,"x":0.0001,"y":0.0123,"z":0.0002,"'":0.0044},"c":{"a":0.1578,"b":0.0005,"c":0.0173,"d":0.0009,"e":0.1051,"f":0.0004,"g":0.0005,"h":0.1569,"i":0.0795,"j":0.0001,"k":0.0557,"l":0.0369,"m":0.0009,"n":0.0021,"o":0.1687,"p":0.0006,"q":0.0015,"r":0.0579,"s":0.0085,"t":0.0653,"u":0.0503,"v":0.0002,"w":0.0003,"x":0.0001,"y":0.0245,"z":0.0006,"'":0.0085},"d":{"a":0.1234,"b":0.0055,"c":0.0031,"d":0.0233,"e":0.2451,"f":0.0044,"g":0.0129,"h":0.0069,"i":0.2059,"j":0.003,"k":0.0008,"l":0.029,"m":0.0083,"n":0.0172,"o":0.1004,"p":0.0026,"q":0.0002,"r":0.0587,"s":0.0383,"t":0.0031,"u":0.0406,"v":0.0048,"w":0.0072,"x":0.0001,"y":0.0211,"z":0.0011,"'":0.0345},"e":{"a":0.0457,"b":0.01,"c":0.0353,"d":0.072,"e":0.0238,"f":0.0101,"g":0.0128,"h":0.0047,"i":0.0151,"j":0.0012,"k":0.0029,"l":0.0642,"m":0.0345,"n":0.1149,"o":0.0146,"p":0.0235,"q":0.0024,"r":0.1984,"s":0.1619,"t":0.0538,"u":0.0136,"v":0.011,"w":0.008,"x":0.0133,"y":0.0086,"z":0.0019,"'":0.0429},"f":{"a":0.102,"b":0.0016,"c":0.0019,"d":0.0014,"e":0.1311,"f":0.0852,"g":0.001,"h":0.0014,"i":0.1796,"j":0.0004,"k":0.0009,"l":0.1027,"m":0.0021,"n":0.0023,"o":0.1403,"p":0.0012,"q":0.0001,"r":0.082,"s":0.0105,"t":0.0339,"u":0.0899,"v":0.0002,"w":0.0011,"x":0.0001,"y":0.0184,"z":0.0002,"'":0.0099},"g":{"a":0.1241,"b":0.0036,"c":0.0011,"d":0.0027,"e":0.1756,"f":0.0022,"g":0.0308,"h":0.0462,"i":0.1203,"j":0.0004,"k":0.001,"l":0.0722,"m":0.0114,"n":0.0373,"o":0.0781,"p":0.0014,"q":0.0001,"r":0.1096,"s":0.0431,"t":0.0054,"u":0.0593,"v":0.0004,"w":0.0042,"x":0.0001,"y":0.0277,"z":0.0004,"'":0.0425},"h":{"a":0.1759,"b":0.0039,"c":0.0019,"d":0.0019,"e":0.2074,"f":0.0028,"g":0.0012,"h":0.0014,"i":0.1675,"j":0.0003,"k":0.0015,"l":0.0195,"m":0.0117,"n":0.0133,"o":0.163,"p":0.0021,"q":0.0003,"r":0.0421,"s":0.0126,"t":0.027,"u":0.0377,"v":0.001,"w":0.0056,"x":0.0001,"y":0.077,"z":0.0004,"'":0.0224},"i":{"a":0.0726,"b":0.0146,"c":0.0984,"d":0.0474,"e":0.0519,"f":0.0173,"g":0.0228,"h":0.0015,"i":0.0023,"j":0.0007,"k":0.0083,"l":0.0603,"m":0.0266,"n":0.1948,"o":0.0684,"p":0.0224,"q":0.0017,"r":0.0254,"s":0.1312,"t":0.0797,"u":0.0091,"v":0.0228,"w":0.0007,"x":0.0028,"y":0.0006,"z":0.0101,"'":0.007},"j":{"a":0.2902,"b":0.0006,"c":0.0022,"d":0.0026,"e":0.1907,"f":0.0007,"g":0.0007,"h":0.0016,"i":0.0786,"j":0.0012,"k":0.0019,"l":0.0016,"m":0.0011,"n":0.0034,"o":0.1976,"p":0.0017,"q":0,"r":0.0032,"s":0.0034,"t":0.0011,"u":0.2101,"v":0.0005,"w":0.0007,"x":0,"y":0.0022,"z":0,"'":0.0036},"k":{"a":0.1208,"b":0.0096,"c":0.003,"d":0.0031,"e":0.2706,"f":0.007,"g":0.0018,"h":0.0252,"i":0.1819,"j":0.0015,"k":0.0068,"l":0.0453,"m":0.0098,"n":0.0266,"o":0.0578,"p":0.0053,"q":0.0002,"r":0.0209,"s":0.0726,"t":0.0107,"u":0.0261,"v":0.0032,"w":0.0119,"x":0.0001,"y":0.0262,"z":0.0001,"'":0.0533},"l":{"a":0.1453,"b":0.0059,"c":0.0077,"d":0.0177,"e":0.1955,"f":0.0059,"g":0.0049,"h":0.002,"i":0.1815,"j":0.0003,"k":0.0057,"l":0.1163,"m":0.0096,"n":0.0068,"o":0.1033,"p":0.0078,"q":0.0002,"r":0.0015,"s":0.02,"t":0.0207,"u":0.0374,"v":0.0068,"w":0.0022,"x":0.0001,"y":0.0791,"z":0.0006,"'":0.0166},"m":{"a":0.2164,"b":0.0438,"c":0.0046,"d":0.0016,"e":0.1884,"f":0.0027,"g":0.0008,"h":0.0011,"i":0.1678,"j":0.0003,"k":0.0006,"l":0.0041,"m":0.0343,"n":0.0097,"o":0.1216,"p":0.063,"q":0.0001,"r":0.0022,"s":0.0326,"t":0.0015,"u":0.0424,"v":0.001,"w":0.0013,"x":0.0001,"y":0.026,"z":0.0002,"'":0.0329},"n":{"a":0.082,"b":0.0061,"c":0.0532,"d":0.0658,"e":0.1479,"f":0.012,"g":0.1216,"h":0.0057,"i":0.0981,"j":0.0023,"k":0.0106,"l":0.0065,"m":0.0055,"n":0.0221,"o":0.0771,"p":0.0076,"q":0.0018,"r":0.0069,"s":0.0674,"t":0.117,"u":0.0145,"v":0.0073,"w":0.0038,"x":0.0005,"y":0.0083,"z":0.0028,"'":0.0469},"o":{"a":0.0151,"b":0.0201,"c":0.0431,"d":0.0326,"e":0.0119,"f":0.0087,"g":0.0401,"h":0.0048,"i":0.0217,"j":0.0009,"k":0.0089,"l":0.0748,"m":0.065,"n":0.1916,"o":0.0329,"p":0.0578,"q":0.0013,"r":0.1172,"s":0.0623,"t":0.052,"u":0.0678,"v":0.0238,"w":0.0206,"x":0.0078,"y":0.0053,"z":0.0036,"'":0.0095},"p":{"a":0.1174,"b":0.0021,"c":0.0017,"d":0.0012,"e":0.156,"f":0.0019,"g":0.0008,"h":0.1493,"i":0.0949,"j":0.0003,"k":0.0008,"l":0.0629,"m":0.0024,"n":0.0043,"o":0.1146,"p":0.0337,"q":0.0001,"r":0.1185,"s":0.0369,"t":0.04,"u":0.0357,"v":0.0003,"w":0.0017,"x":0.0001,"y":0.0159,"z":0.0001,"'":0.0077},"q":{"a":0.0111,"b":0.0007,"c":0.0005,"d":0.0008,"e":0.0017,"f":0.0005,"g":0.0003,"h":0.0003,"i":0.0064,"j":0,"k":0.0006,"l":0.001,"m":0.0009,"n":0.0007,"o":0.0012,"p":0.0004,"q":0.0011,"r":0.0015,"s":0.0028,"t":0.0011,"u":0.9635,"v":0.0005,"w":0.0009,"x":0,"y":0.0004,"z":0,"'":0.0031},"r":{"a":0.1517,"b":0.0136,"c":0.0235,"d":0.0277,"e":0.1603,"f":0.0065,"g":0.0171,"h":0.0088,"i":0.1534,"j":0.0009,"k":0.01,"l":0.0132,"m":0.027,"n":0.0208,"o":0.1296,"p":0.0142,"q":0.0008,"r":0.0254,"s":0.0528,"t":0.0388,"u":0.0282,"v":0.0079,"w":0.0042,"x":0.0001,"y":0.031,"z":0.001,"'":0.0328},"s":{"a":0.0596,"b":0.0054,"c":0.0501,"d":0.0021,"e":0.1281,"f":0.0028,"g":0.0016,"h":0.0627,"i":0.092,"j":0.0004,"k":0.0125,"l":0.0171,"m":0.043,"n":0.0146,"o":0.0466,"p":0.0422,"q":0.0051,"r":0.0018,"s":0.1151,"t":0.177,"u":0.0483,"v":0.0038,"w":0.0083,"x":0.0001,"y":0.0146,"z":0.0005,"'":0.0457},"t":{"a":0.1027,"b":0.0027,"c":0.0092,"d":0.0011,"e":0.1927,"f":0.0033,"g":0.0015,"h":0.08,"i":0.2156,"j":0.0005,"k":0.0006,"l":0.0149,"m":0.0045,"n":0.0039,"o":0.1028,"p":0.0021,"q":0.0001,"r":0.0907,"s":0.0353,"t":0.0331,"u":0.0339,"v":0.0008,"w":0.0056,"x":0.0001,"y":0.0324,"z":0.0035,"'":0.0278},"u":{"a":0.0335,"b":0.0383,"c":0.0373,"d":0.0293,"e":0.0301,"f":0.0085,"g":0.0207,"h":0.0015,"i":0.0337,"j":0.0011,"k":0.0065,"l":0.1035,"m":0.0724,"n":0.1741,"o":0.0075,"p":0.0373,"q":0.0006,"r":0.1226,"s":0.153,"t":0.0708,"u":0.0008,"v":0.0042,"w":0.0006,"x":0.0038,"y":0.0019,"z":0.0033,"'":0.0042},"v":{"a":0.1627,"b":0.0001,"c":0.0008,"d":0.0009,"e":0.4642,"f":0.0002,"g":0.0005,"h":0.0004,"i":0.2576,"j":0.0001,"k":0.0008,"l":0.0027,"m":0.0005,"n":0.0014,"o":0.0734,"p":0.0004,"q":0,"r":0.005,"s":0.0039,"t":0.0009,"u":0.013,"v":0.002,"w":0.0001,"x":0.0001,"y":0.0054,"z":0.0002,"'":0.004},"w":{"a":0.2317,"b":0.0113,"c":0.0039,"d":0.0111,"e":0.1605,"f":0.006,"g":0.0023,"h":0.0604,"i":0.1581,"j":0.0003,"k":0.0082,"l":0.0255,"m":0.0076,"n":0.0532,"o":0.1482,"p":0.0051,"q":0.0001,"r":0.0292,"s":0.0316,"t":0.0082,"u":0.0065,"v":0.0008,"w":0.0034,"x":0.0001,"y":0.0112,"z":0.001,"'":0.0158},"x":{"a":0.1072,"b":0.006,"c":0.0542,"d":0.0022,"e":0.1235,"f":0.0058,"g":0.0014,"h":0.0187,"i":0.2164,"j":0,"k":0.0004,"l":0.0079,"m":0.0058,"n":0.002,"o":0.0804,"p":0.0849,"q":0.0012,"r":0.0015,"s":0.0107,"t":0.1113,"u":0.0295,"v":0.0021,"w":0.004,"x":0.0015,"y":0.0736,"z":0.0003,"'":0.0488},"y":{"a":0.0649,"b":0.0153,"c":0.0585,"d":0.0354,"e":0.048,"f":0.0057,"g":0.0215,"h":0.0052,"i":0.0328,"j":0.0005,"k":0.0037,"l":0.0927,"m":0.0579,"n":0.0656,"o":0.044,"p":0.0827,"q":0.0002,"r":0.0523,"s":0.089,"t":0.0544,"u":0.0094,"v":0.0046,"w":0.0087,"x":0.0055,"y":0.0006,"z":0.0037,"'":0.1387},"z":{"a":0.1754,"b":0.0058,"c":0.0028,"d":0.0028,"e":0.2673,"f":0.0008,"g":0.0017,"h":0.0078,"i":0.1596,"j":0.0002,"k":0.0043,"l":0.024,"m":0.0051,"n":0.0034,"o":0.1736,"p":0.002,"q":0.0007,"r":0.0028,"s":0.0041,"t":0.0034,"u":0.0216,"v":0.0023,"w":0.0038,"x":0,"y":0.0383,"z":0.0628,"'":0.0251},"'":{"a":0.0005,"b":0.0001,"c":0.0002,"d":0.0004,"e":0.0002,"f":0.0001,"g":0.0001,"h":0.0001,"i":0.0002,"j":0,"k":0.0001,"l":0.0002,"m":0.0001,"n":0.0002,"o":0.0002,"p":0.0001,"q":0,"r":0.0001,"s":0.9974,"t":0.0003,"u":0.0001,"v":0.0001,"w":0.0001,"x":0,"y":0.0001,"z":0,"'":0}};

function getPolyHashFunction(p, mod) {
  return word => word.split('').reduce((hash, s) => (hash * p + s.charCodeAt(0)) % mod, 0);
}

//const hashes = [[31, 1e9 + 7], [61, 1e9 + 9]].map(args => getPolyHashFunction.apply(null, args));
const hashes = [[31, 1e9 + 7]].map(args => getPolyHashFunction.apply(null, args));

class Solver {
  init(buffer) {
    this.bloomFilter = new BloomFilter(buffer, hashes);
  }

  test(word) {
    word = word.toLowerCase();
    if (this.bloomFilter.test(word)) {
      const bigrams = word.split('').slice(1).map((c, i) => word[i] + c);
      const prob = bigrams.reduce((prob, bigram) => Math.min(prob, freq[bigram[0]][bigram[1]]), 1);
      return prob >= 0.01;
    }

    return false;
  }
};

module.exports = new Solver();
